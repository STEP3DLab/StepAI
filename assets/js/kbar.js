(function(){
  const kbar=document.getElementById('kbar');const input=document.getElementById('kbarInput');const list=document.getElementById('kbarList');const btn=document.getElementById('searchBtn');const btnMobile=document.getElementById('ctaSearch');
  if(!kbar||!input||!list) return;
  let items=[];let sel=0;function build(){items=[{title:'О нас',href:'#about',type:'Раздел'},{title:'Услуги',href:'#services',type:'Раздел'},{title:'Калькулятор',href:'#estimator',type:'Раздел'},{title:'Проекты',href:'#projects',type:'Раздел'},{title:'Блог',href:'#blog',type:'Раздел'},{title:'Контакты',href:'#contact',type:'Раздел'},
    {title:'Сменить тему',action:()=>toggleTheme(),type:'Команда'},{title:'Наверх',action:()=>window.scrollTo({top:0,behavior:'smooth'}),type:'Команда'},{title:'Контакты',href:'#contact',type:'Команда'},{title:'Скопировать ссылку',action:async()=>{await navigator.clipboard.writeText(location.href);toast('Ссылка скопирована');},type:'Команда'}
  ].concat((window.PROJECTS||[]).map(p=>({title:p.title,sub:(p.tags||[]).join(', '),href:'#projects',type:'Проект'}))).concat((window.POSTS||[]).map(p=>({title:p.title,sub:p.excerpt,href:'#blog',type:'Пост'})));}
  function open(){build();kbar.hidden=false;input.value='';render('');setTimeout(()=>input.focus(),0);logger?.log('kbar_open');}
  function close(){kbar.hidden=true;}
  function highlight(text,qq){if(!qq)return text;const i=text.toLowerCase().indexOf(qq.toLowerCase());if(i<0)return text;return text.substring(0,i)+'<mark>'+text.substring(i,i+qq.length)+'</mark>'+text.substring(i+qq.length);}
  function render(q){const qq=q.toLowerCase().trim();sel=0;const view=items.map(it=>{const hay=(it.title+' '+(it.sub||'')).toLowerCase();let score=!qq?2:hay.includes(qq)?1+(it.title.toLowerCase().startsWith(qq)?1:0):0;return {...it,score};}).filter(i=>i.score>0).sort((a,b)=>b.score-a.score).slice(0,10);list.innerHTML=view.map((i,idx)=>`<div class="kbar__item${idx===0?' active':''}" data-href="${i.href||''}" data-idx="${idx}"><div><div>${highlight(i.title,qq)}</div>${i.sub?`<div class='soft' style='font-size:12px'>${highlight(i.sub,qq)}</div>`:''}</div><div class="kbar__type">${i.type}</div></div>`).join('')||'<div class="kbar__item">Ничего не найдено</div>';}
  function onKey(e){if((e.key==='k'&&(e.metaKey||e.ctrlKey))||(e.key==='/'&&e.target.tagName!=='INPUT'&&e.target.tagName!=='TEXTAREA')){e.preventDefault();open();return;}if(kbar.hidden)return;if(e.key==='Escape'){close();return;}const els=[...list.querySelectorAll('.kbar__item[data-href]')];if(!els.length)return;if(e.key==='ArrowDown'){e.preventDefault();sel=(sel+1)%els.length;els.forEach((el,i)=>el.classList.toggle('active',i===sel));return;}if(e.key==='ArrowUp'){e.preventDefault();sel=(sel-1+els.length)%els.length;els.forEach((el,i)=>el.classList.toggle('active',i===sel));return;}if(e.key==='Home'){e.preventDefault();sel=0;els.forEach((el,i)=>el.classList.toggle('active',i===sel));return;}if(e.key==='End'){e.preventDefault();sel=els.length-1;els.forEach((el,i)=>el.classList.toggle('active',i===sel));return;}if(e.key==='Enter'){e.preventDefault();const item=viewItem(sel);if(item){if(item.href)location.hash=item.href;if(item.action)item.action();}close();}}
  function viewItem(idx){const qq=input.value.toLowerCase().trim();const view=items.map(it=>{const hay=(it.title+' '+(it.sub||'')).toLowerCase();let score=!qq?2:hay.includes(qq)?1+(it.title.toLowerCase().startsWith(qq)?1:0):0;return {...it,score};}).filter(i=>i.score>0).sort((a,b)=>b.score-a.score).slice(0,10);return view[idx];}
  input.addEventListener('input',e=>render(e.target.value));
  list.addEventListener('click',e=>{const el=e.target.closest('.kbar__item');if(!el)return;const item=viewItem(+el.dataset.idx);if(item){if(item.href)location.hash=item.href;if(item.action)item.action();}close();});
  document.addEventListener('keydown',onKey);btn?.addEventListener('click',open);btnMobile?.addEventListener('click',open);kbar.addEventListener('click',e=>{if(e.target.id==='kbar')close();});
  kbar.addEventListener('keydown',e=>{if(kbar.hidden)return;if(e.key==='Tab'){const focusables=[input,...kbar.querySelectorAll('.kbar__item')];let i=focusables.indexOf(document.activeElement);i=e.shiftKey?(i-1+focusables.length)%focusables.length:(i+1)%focusables.length;focusables[i].focus?.();e.preventDefault();}});
})();
